<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="mvc-tasks">
    <template>
        <style include="shared-styles"></style>

        <style>
            .task paper-material {
                width: 100%;
                padding: 10px;
            }

            .task paper-input, .user-name {
                margin-left: 5px;
                margin-right: 5px;
            }

            .user-name {
                color: var(--secondary-text-color);
            }

            #noTasks {
                visibility: hidden;
            }
        </style>

        <iron-ajax id="ajaxList" auto
                   url="http://localhost:8080/polymer-javaee-mvc-todo-1.0-SNAPSHOT/resources/tasks/list"
                   handle-as="json" debounce-duration="300"
                   last-response="{{tasks}}"></iron-ajax>

        <iron-ajax id="ajaxDelete"
                   method="delete"
                   on-response="_deleteTaskComplete"
                   debounce-duration="300"></iron-ajax>

        <iron-ajax id="ajaxAdd" method="post"
                   content-type="application/json" ,
                   url="http://localhost:8080/polymer-javaee-mvc-todo-1.0-SNAPSHOT/resources/tasks/add"
                   handle-as="json"
                   on-response="_addTaskComplete"
                   debounce-duration="300"></iron-ajax>

        <iron-ajax id="ajaxUpdate" method="put"
                   content-type="application/json" ,
                   handle-as="json"
                   debounce-duration="300"></iron-ajax>


        <paper-button on-click="_newTask"
        <iron-icon icon="add-box"></iron-icon>
        Add a Task
        </paper-button>

        <div class="list short" role="list">
            <template id="taskList" is="dom-repeat" items="[[tasks]]">
                <paper-item class="task" role="menuitemcheckbox" on-click="_selectTask">
                    <paper-material class="layout horizontal end">
                        <paper-checkbox id="taskCompleted" checked="{{item.completed}}"></paper-checkbox>
                        <span class="user-name">User: <span>[[item.userId]]</span></span>
                        <paper-input id="taskName" class="flex" label="Task" value="{{item.name}}"></paper-input>
                        <paper-icon-button id="taskSave" icon="save" on-click="_saveTask"></paper-icon-button>
                        <paper-icon-button id="taskDelete" icon="delete" on-click="_deleteTask"></paper-icon-button>
                    </paper-material>
                </paper-item>
            </template>
        </div>
    </template>

    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'mvc-tasks',

                properties: {
                    endpoint: {
                        type: String
                    },

                    selectedTask: {
                        type: Object
                    }
                },

                _selectTask: function (event) {
                    this.selectedTask = this.$.taskList.itemForElement(event.target);
                    console.log("Selected task: " + this.selectedTask.name);
                },

                _newTask: function (event) {
                    var task = {new: true, name: "", completed: false, userId: 'You'};
                    this.splice('tasks', 0, 0, task);
                },

                _saveTask: function (event) {
                    // This is called before the _selectTask, so we have to grab the value manually.
                    var task = this._getTaskFromEvent(event);
                    var ajaxElement;
                    if (task.new) {
                        ajaxElement = this.$.ajaxAdd;
                    } else {
                        ajaxElement = this.$.ajaxUpdate;
                        ajaxElement.url = "http://localhost:8080/polymer-javaee-mvc-todo-1.0-SNAPSHOT/resources/tasks/" + task.id;
                    }
                    ajaxElement.body = task;
                    ajaxElement.generateRequest();
                },

                _addTaskComplete: function (event) {
                    var taskFromServer = this.$.ajaxAdd.lastResponse;
                    this.selectedTask.id = taskFromServer.id;
                },

                _deleteTask: function (event) {
                    // This is called before the _selectTask, so we have to grab the value manually.
                    var task = this.$.taskList.itemForElement(event.target);
                    this.$.ajaxDelete.url = "http://localhost:8080/polymer-javaee-mvc-todo-1.0-SNAPSHOT/resources/tasks/" + task.id;
                    this.$.ajaxDelete.generateRequest();
                },

                _deleteTaskComplete: function (event) {
                    var items = this.$.taskList.items;
                    var index = items.indexOf(this.selectedTask);
                    this.splice('tasks', index, 1);
                },

                _getTaskFromEvent: function (event) {
                    return this.$.taskList.itemForElement(event.target);
                }

            });
        })();
    </script>

</dom-module>
